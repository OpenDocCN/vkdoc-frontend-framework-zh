# 三、将 Angular 放在上下文中

在这一章中，我将 Angular 放在 web 应用开发的环境中，为后面的章节打下基础。Angular 的目标是将只适用于服务器端开发的工具和功能引入到 web 客户端，这样做可以使开发、测试和维护丰富复杂的 web 应用变得更加容易。

Angular 的工作原理是允许你*扩展* HTML，这看起来是一个奇怪的想法，直到你习惯了它。Angular 应用通过自定义元素表达功能，复杂的应用可以生成一个包含标准和自定义标记的 HTML 文档。

Angular 支持的开发风格是通过使用*模型-视图-控制器* (MVC)模式派生出来的，尽管这有时被称为模型-视图- *什么的*，因为在使用 Angular 时可以遵循这种模式的无数变体。在本书中，我将把重点放在标准 MVC 模式上，因为它是最成熟和最广泛使用的模式。在接下来的章节中，我解释了 Angular 可以带来显著好处的项目的特征(以及那些存在更好的替代方案的项目)，描述了 MVC 模式，并描述了一些常见的陷阱。

This Book and the Angular Release Schedule

谷歌对 Angular 采取了积极的发布时间表。这意味着每六个月就会有一个小版本和一个大版本。次要版本不应该破坏任何现有功能，并且应该主要包含错误修复。主要版本可能包含重大更改，并且可能不提供向后兼容性。

要求读者每六个月购买这本书的新版本似乎不公平也不合理，尤其是因为即使在主要版本中，大多数 Angular 特征也不太可能改变。取而代之的是，我将在本书 [`https://github.com/Apress/pro-angular-9`](https://github.com/Apress/pro-angular-9) 的 GitHub 资源库中发布主要版本的更新。

对我来说(对出版社来说)这是一个正在进行的实验，但目标是通过补充书中包含的例子来延长这本书的寿命。

我不承诺更新会是什么样的，它们会采取什么形式，或者在我把它们折叠成这本书的新版本之前，我会花多长时间来制作它们。请保持开放的心态，并在新版本发布时查看这本书的资源库。如果您对如何改进更新有任何想法，请发电子邮件至`adam@adam-freeman.com`告诉我。

## 了解 Angular 的优势

Angular 不是所有问题的解决方案，知道什么时候应该使用 Angular，什么时候应该寻求替代方案是很重要的。Angular 提供了以前只有服务器端开发人员才能使用的功能，但完全是在浏览器中。这意味着 Angular 在每次加载应用了 Angular 的 HTML 文档时都有大量的工作要做——必须编译 HTML 元素，必须评估数据绑定，必须执行组件和其他构建块，等等。所有这些工作都是构建我在第 [2](02.html) 章中演示的特性以及我在本书后面描述的特性所必需的。

这种工作需要时间，时间的长短取决于 HTML 文档的复杂程度、相关的 JavaScript 代码，以及关键的浏览器质量和设备的处理能力。在功能强大的台式机上使用最新的浏览器时，你不会注意到任何延迟，但功能不足的智能手机上的旧浏览器确实会减慢 Angular 应用的初始设置。

目标是尽可能少地执行这种设置，并在执行时向用户交付尽可能多的应用。这意味着仔细考虑您构建的 web 应用的类型。从广义上讲，web 应用有两种:*往返*和*单页*。

### 了解往返和单页应用

很长一段时间以来，web 应用的开发都遵循一个*往返*模型。浏览器向服务器请求一个初始的 HTML 文档。用户交互——比如单击一个链接或提交一个表单——使浏览器请求并接收一个全新的 HTML 文档。在这种应用中，浏览器本质上是 HTML 内容的呈现引擎，所有的应用逻辑和数据都驻留在服务器上。浏览器发出一系列无状态的 HTTP 请求，服务器通过动态生成 HTML 文档来处理这些请求。

许多当前的 web 开发仍然是针对往返应用的，尤其是因为它们对浏览器的要求很少，这确保了尽可能广泛的客户端支持。但是往返应用也有一些缺点:它们让用户在请求和加载下一个 HTML 文档时等待，它们需要大型的服务器端基础设施来处理所有请求和管理所有应用状态，并且它们需要更多的带宽，因为每个 HTML 文档都必须是自包含的(导致服务器的每个响应中都包含大量相同的内容)。

单页应用采取了不同的方法。一个初始的 HTML 文档被发送到浏览器，但是用户交互会导致 Ajax 请求将小的 HTML 片段或数据插入到向用户显示的现有元素集中。初始的 HTML 文档永远不会被重新加载或替换，当 Ajax 请求被异步执行时，用户可以继续与现有的 HTML 交互，即使这只是意味着看到一个“数据加载”消息。

Angular 擅长单页应用，尤其是复杂的往返应用。对于更简单的项目，直接使用 DOM API 或者通过更简单的库(比如 jQuery)使用通常是更好的选择，尽管没有什么可以阻止您在所有项目中使用 Angular。

单页应用模型对于 Angular 来说是完美的，不仅仅是因为初始化过程，还因为使用 MVC 模式(我将在本章后面描述)的好处真正开始在更大更复杂的项目中体现出来，这些项目正在向单页模型推进。

Tip

你可能遇到的另一个短语是*渐进式网络应用* (PWAs)。渐进式应用即使在与网络断开连接时也能继续工作，并且可以访问推送通知等功能。PWA 不是 Angular 特有的，但是我在第 [10](10.html) 章演示了如何使用简单的 PWA 特性。

## 比较 Angular to React 和 Vue.js

Angular 有两个主要的竞争对手:React 和 Vue.js。它们之间有一些低级的差异，但是，在大多数情况下，所有这些框架都很优秀，它们都以相似的方式工作，并且它们都可以用来创建丰富而流畅的客户端应用。

这些框架之间的主要区别在于开发人员的体验。例如，Angular 要求您使用 TypeScript 才能有效。如果您习惯于使用 C#或 Java 之类的语言，那么 TypeScript 将会很熟悉，并且可以避免处理 JavaScript 语言的一些奇怪之处。Vue.js 和 React 不需要 TypeScript(尽管这两个框架都支持)，但倾向于将 HTML、JavaScript 和 CSS 内容混合在一个文件中，这不是每个人都喜欢的。

我的建议很简单:选择你最喜欢的框架，如果你不喜欢，就换一个。这可能看起来是一种不科学的方法，但是这并不是一个坏的选择，并且您会发现许多核心概念会在框架之间延续，即使您进行了转换。

## 理解 MVC 模式

术语*模型-视图-控制器*从 20 世纪 70 年代末就开始使用，起源于施乐 PARC 公司的 Smalltalk 项目，当时它被认为是一种组织早期 GUI 应用的方法。最初 MVC 模式的一些细节依赖于 Smalltalk 特有的概念，例如*屏幕*和*工具*，但是更广泛的思想仍然适用于应用，并且它们特别适合于 web 应用。

MVC 模式最初通过 Ruby on Rails 和 ASP.NET MVC 框架等工具包在 web 开发的服务器端站稳了脚跟。近年来，MVC 模式也被视为管理客户端 web 开发日益丰富和复杂的一种方式，Angular 就是在这种环境下出现的。

应用 MVC 模式的关键是实现关注点分离的关键前提，其中应用中的数据模型与业务和表示逻辑相分离。在客户端 web 开发中，这意味着分离数据、对数据进行操作的逻辑以及用于显示数据的 HTML 元素。结果是客户端应用更容易开发、维护和测试。

三个主要的构建模块是*模型*、*控制器*和*视图*。在图 [3-1](#Fig1) 中，你可以看到 MVC 模式应用于服务器端开发的传统阐述。

![img/421542_4_En_3_Fig1_HTML.jpg](img/421542_4_En_3_Fig1_HTML.jpg)

图 3-1。

MVC 模式的服务器端实现

我从我的一本*Pro ASP.NET 核心*书中获得了这个数字，该书描述了微软的 MVC 模式的服务器端实现。您可以看到期望是从数据库中获得模型，并且应用的目标是服务来自浏览器的 HTTP 请求。这是我前面描述的往返 web 应用的基础。

当然，浏览器中存在 Angular，导致了 MVC 主题的扭曲，如图 [3-2](#Fig2) 所示。

![img/421542_4_En_3_Fig2_HTML.jpg](img/421542_4_En_3_Fig2_HTML.jpg)

图 3-2。

MVC 模式的客户端实现

MVC 模式的客户端实现从服务器端组件获取数据，通常是通过 RESTful web 服务，我在第 [24](24.html) 章对此进行了描述。控制器和视图的目标是操作模型中的数据以执行 DOM 操作，从而创建和管理用户可以与之交互的 HTML 元素。这些交互被反馈给控制器，形成一个交互应用的闭环。

Angular 对其构建块使用了稍微不同的术语，这意味着使用 Angular 实现的 MVC 模型看起来更像图 [3-3](#Fig3) 。

![img/421542_4_En_3_Fig3_HTML.jpg](img/421542_4_En_3_Fig3_HTML.jpg)

图 3-3。

MVC 模式的 Angular 实现

该图显示了 Angular 构建块到 MVC 模式的基本映射。为了支持 MVC 模式，Angular 提供了一系列额外的特性，我在整本书中都有描述。

Tip

使用像 Angular 这样的客户端框架并不排除使用服务器端 MVC 框架，但是您会发现 Angular 客户端承担了一些原本存在于服务器端的复杂性。这通常是一件好事，因为它将工作从服务器转移到了客户端，这样就可以用更少的服务器容量支持更多的客户端。

Patterns and Pattern Zealots

一个好的模式描述了一种解决问题的方法，这种方法对*其他*项目中的*其他*人有效。模式是食谱，而不是规则，您需要调整任何模式以适应您的特定项目，就像厨师调整食谱以适应不同的烤箱和配料一样。

你偏离一个模式的程度应该由需求和经验来决定。你在类似的项目中应用一个模式所花费的时间将会告诉你什么对你有用，什么对你没用。如果您是一个模式的新手，或者您正在着手一个新的项目，那么您应该尽可能地坚持这个模式，直到您真正理解等待您的好处和陷阱。但是，注意不要围绕一个模式来改革你的整个开发工作，因为大范围的中断通常会导致生产力的损失，破坏你希望该模式给出的任何结果。

模式是灵活的工具，而不是固定的规则，但并不是所有的开发人员都理解这种差异，有些人成为了*模式狂热者*。这些人花更多的时间谈论模式，而不是将其应用到项目中，并认为任何偏离他们对模式的解释都是严重的犯罪。我的建议是简单地忽略这种人，因为任何一种接触都会让你筋疲力尽，而且你永远无法改变他们的想法。相反，只要继续做一些工作，并通过实际的应用和交付演示一个模式的灵活应用如何产生好的结果。

记住这一点，你会看到我在本书的例子中遵循了 MVC 模式的广泛概念，但是我调整了模式来演示不同的特性和技术。这就是我在我自己的项目中的工作方式——拥抱模式中提供价值的部分，将那些不提供价值的部分放在一边。

### 理解模型

模型 MVC 中的*M*——包含用户使用的数据。有两种广泛的模型类型:*视图模型*，它只表示从组件传递到模板的数据，以及*域模型*，它包含业务域中的数据，以及创建、存储和操作这些数据的操作、转换和规则，统称为*模型逻辑*。

Tip

许多不熟悉 MVC 模式的开发人员对在数据模型中包含逻辑的想法感到困惑，认为 MVC 模式的目标是将数据与逻辑分离。这是一个误解:MVC 框架的目标是将应用分成三个功能区域，每个区域可能包含逻辑*和*数据。目标不是从模型中消除逻辑。相反，它是为了确保模型只包含用于创建和管理模型数据的逻辑。

你不可能在没有被单词 *business* 绊倒的情况下阅读 MVC 模式的定义，这是不幸的，因为许多 web 开发远远超出了导致这种术语的业务线应用。然而，业务应用仍然是开发世界的一大块，如果你正在编写，比如说，一个销售会计系统，那么你的业务领域将包含与销售会计相关的过程，你的领域模型将包含帐户数据和创建、存储和管理帐户的逻辑。如果你是在创建猫视频网站，那么你还是有业务领域的；只是它可能不适合公司的结构。您的领域模型将包含 cat 视频以及创建、存储和操作这些视频的逻辑。

许多 Angular 模型会有效地将逻辑推到服务器端，并通过 RESTful web 服务调用它，因为浏览器中很少支持数据持久性，而且通过 Ajax 更容易获得所需的数据。我会在第 24 章中解释 Angular 如何用于 RESTful web 服务。对于 MVC 模式中的每一个元素，我将描述哪些应该包含，哪些不应该包含。使用 MVC 模式构建的应用中的模型*应该*

*   包含域数据

*   包含创建、管理和修改域数据的逻辑(即使这意味着通过 web 服务执行远程逻辑)

*   提供一个清晰的 API，公开模型数据和操作

型号*不应*

*   公开如何获得或管理模型数据的细节(换句话说，数据存储机制或远程 web 服务的细节不应该向控制器和视图公开)

*   包含基于用户交互转换模型的逻辑(因为这是组件的工作)

*   包含向用户显示数据的逻辑(这是模板的工作)

确保模型与控制器和视图隔离的好处是你可以更容易地测试你的逻辑(我在第 [29](29.html) 章描述了 Angular 单元测试),并且增强/维护整个应用更加简单和容易。

最好的域模型包含持久获取和存储数据的逻辑，包含创建、读取、更新和删除操作的逻辑(统称为 CRUD)或查询和修改数据的独立模型，称为命令和查询责任分离(CQRS)模式。

这可能意味着模型直接包含逻辑，但更常见的是，模型将包含调用 RESTful web 服务的逻辑，以调用服务器端数据库操作(当我构建一个真实的 Angular 应用时，我将在第 [8](08.html) 章中演示，我将在第 [24](24.html) 章中详细描述)。

### 了解控制器/组件

控制器在 Angular 中被称为*组件*，是 Angular web app 中的结缔组织；它们充当数据模型和视图之间的管道。组件添加了表示模型的各个方面并对其执行操作所需的业务领域逻辑。遵循 MVC 模式的组件*应该*

*   包含设置模板初始状态所需的逻辑

*   包含模板所需的逻辑/行为，以呈现模型中的数据

*   包含基于用户交互更新模型所需的逻辑/行为

组件*不应*

*   包含操作 DOM 的逻辑(这是模板的工作)

*   包含管理数据持久性的逻辑(这是模型的工作)

#### 了解视图数据

领域模型并不是 Angular 应用中的唯一数据。组件可以创建*视图数据*(也称为*视图模型数据*或*视图模型*)来简化模板及其与组件的交互。

### 了解视图/模板

视图，在 Angular 中被称为*模板*，是使用通过数据绑定增强的 HTML 元素定义的。正是数据绑定使得 Angular 如此灵活，它们将 HTML 元素转化为动态 web 应用的基础。我将在第 2 部分详细解释 Angular 提供的不同类型的数据绑定。模板*应该*

*   包含向用户显示数据所需的逻辑和标记

模板*不应*

*   包含复杂的逻辑(最好放在一个组件或其他有 Angular 的构建块中，如指令、服务或管道)

*   包含创建、存储或操作领域模型的逻辑

模板*可以*包含逻辑，但是应该简单，少用。除了最简单的方法调用或表达式之外，在模板中放置任何东西都会使整个应用更难测试和维护。

## 理解 RESTful 服务

Angular 应用中的领域模型逻辑通常在客户端和服务器端分开。服务器包含持久性存储，通常是一个数据库，并包含管理它的逻辑。例如，在 SQL 数据库的情况下，所需的逻辑将包括打开到数据库服务器的连接，执行 SQL 查询，并处理结果以便将它们发送到客户机。

您不希望客户端代码直接访问数据存储—这样做会在客户端和数据存储之间产生紧密耦合，这会使单元测试变得复杂，并且在不更改客户端代码的情况下很难更改数据存储。

通过使用服务器来协调对数据存储的访问，可以防止紧耦合。客户端上的逻辑负责从服务器获取数据，并不知道在后台如何存储或访问数据的细节。

在客户机和服务器之间传递数据有很多种方式。最常见的一种是使用*异步 JavaScript 和 XML* (Ajax)请求来调用服务器端代码，让服务器发送 JSON 并使用 HTML 表单对数据进行更改。

这种方法可以很好地工作，并且是 RESTful web 服务的基础，RESTful web 服务使用 HTTP 请求的性质对数据执行 CRUD 操作。

Note

REST 是 API 的一种风格，而不是一个定义良好的规范，对于什么样的 web 服务才是 RESTful 的还存在争议。争论的一点是纯粹主义者不认为返回 JSON 的 web 服务是 RESTful 的。就像任何关于架构模式的分歧一样，分歧的原因是任意的和乏味的，根本不值得担心。就我而言，JSON 服务*是 RESTful 的，我在本书中也是这样看待它们的。*

在 RESTful web 服务中，被请求的操作通过 HTTP 方法和 URL 的组合来表达。例如，想象这样一个 URL:

```ts
http://myserver.mydomain.com/people/bob

```

RESTful web 服务没有标准的 URL 规范，但其思想是使 URL 不言自明，这样 URL 所指的内容就很明显了。在这种情况下，很明显有一个名为`people`的数据对象集合，并且 URL 指向该集合中标识为`bob`的特定对象。

Tip

在实际项目中并不总是能够创建这种不言自明的 URL，但是您应该努力保持简单，不要通过 URL 暴露数据存储的内部结构(因为这只是组件之间的另一种耦合)。尽可能保持你的 URL 简单，并保持 URL 格式和服务器中数据结构之间的映射。

URL 标识我想要操作的数据对象，HTTP 方法指定我想要执行什么操作，如表 [3-1](#Tab1) 所述。

表 3-1。

响应 HTTP 方法时通常执行的操作

<colgroup><col class="tcol1 align-left"> <col class="tcol2 align-left"></colgroup> 
| 

方法

 | 

描述

 |
| --- | --- |
| `GET` | 检索由 URL 指定的数据对象 |
| `PUT` | 更新由 URL 指定的数据对象 |
| `POST` | 创建新的数据对象，通常使用表单数据值作为数据字段 |
| `DELETE` | 删除由 URL 指定的数据对象 |

您不必使用 HTTP 方法来执行我在表中描述的操作。一个常见的变化是 POST 方法通常用于双重用途，如果存在对象，它将更新对象，如果不存在，它将创建一个对象，这意味着不使用 PUT 方法。在第 24 章中，我描述了 Angular 为 Ajax 和 RESTful 服务提供的支持。

Idempotent HTTP Methods

您可以在 HTTP 方法和数据存储上的操作之间实现任何映射，尽管我建议您尽可能遵循我在表中描述的约定。

如果您偏离了正常的方法，请确保遵循 HTTP 规范中定义的 HTTP 方法的本质。GET 方法是*nullipent*，这意味着响应这个方法而执行的操作应该只检索数据，而不修改数据。浏览器(或任何中间设备，如代理)希望能够重复发出 GET 请求，而不改变服务器的状态(尽管这并不意味着服务器的状态不会因为来自其他客户机的请求而在相同的 GET 请求之间改变)。

PUT 和 DELETE 方法是*等幂*，这意味着多个相同的请求应该具有与单个请求相同的效果。因此，例如，使用带有`/people/bob` URL 的 DELETE 方法应该为第一个请求从`people`集合中删除`bob`对象，然后对后续请求不做任何事情。(同样，当然，如果另一个客户机重新创建了`bob`对象，这就不成立。)

POST 方法既不是无效的也不是等幂的，这就是为什么一个常见的 RESTful 优化是处理对象创建*和*更新。如果没有`bob`对象，使用 POST 方法将创建一个对象，对同一 URL 的后续 POST 请求将更新已创建的对象。

只有当您实现自己的 RESTful web 服务时，所有这些才是重要的。如果您正在编写一个使用 RESTful 服务的客户端，那么您只需要知道每个 HTTP 方法对应的数据操作。我将在第 8 章中演示如何使用这样的服务，并在第 24 章[中更详细地描述 HTTP 请求的 Angular 特性。](24.html)

## 常见的设计陷阱

在这一节中，我描述了我在 Angular 项目中遇到的三个最常见的设计陷阱。这些不是编码错误，而是 web 应用整体形状的问题，这些问题阻碍了项目团队获得 Angular 和 MVC 模式所能提供的好处。

### 把逻辑放在错误的地方

最常见的问题是将逻辑放入了错误的组件中，从而破坏了 MVC 关注点分离。以下是这一问题的三种最常见形式:

*   将业务逻辑放在模板中，而不是组件中

*   将领域逻辑放在组件中，而不是模型中

*   当使用 RESTful 服务时，将数据存储逻辑放在客户端模型中

这些都是棘手的问题，因为它们需要一段时间才能显现为问题。应用仍然可以运行，但是随着时间的推移，它将变得更加难以增强和维护。在第三种情况下，只有当数据存储发生变化时，问题才会变得明显(这种情况很少发生，直到项目成熟，并且已经超出了最初的用户预测)。

Tip

对逻辑应该去哪里有一个感觉需要一些经验，但是如果你使用单元测试，你会更早发现问题，因为你必须写的覆盖逻辑的测试不能很好地适应 MVC 模式。我在第 29 章中描述了单元测试的 Angular 支持。

当你在 Angular 发展中获得更多经验时，知道在哪里放置逻辑成为第二天性，但是这里有三个规则:

*   模板逻辑应该只准备用于显示的数据，而不修改模型。

*   组件逻辑不应该直接从模型中创建、更新或删除数据。

*   模板和组件不应该直接访问数据存储。

如果您在开发时记住这些，您将避免最常见的问题。

### 采用数据存储数据格式

当开发团队构建依赖于服务器端数据存储的应用时，下一个问题就出现了。在一个从 RESTful 服务获取数据的设计良好的 Angular 应用中，服务器的工作是隐藏数据存储实现细节，并以有利于简化客户端的适当数据格式向客户端呈现数据。例如，决定客户端需要如何表示日期，然后确保您在数据存储中使用该格式——如果数据存储本身不支持该格式，则由服务器执行转换。

### 只是足够制造麻烦的知识

Angular 是一个复杂的框架，在你习惯它之前，你会感到困惑。有许多不同的构建模块可用，它们可以以不同的方式组合来实现类似的结果。这使得 Angular 开发变得灵活，并且意味着您将通过创建适合您的项目和工作风格的特性组合来开发您自己的问题解决风格。

精通 Angular 需要时间。在了解 Angular 的不同部分是如何组合在一起的之前，你很容易就开始创建自己的项目。你可能在没有真正理解它为什么会起作用的情况下生产出一些有用的东西，当你需要做出改变的时候，这是一个灾难的处方。我的建议是慢慢来，花时间了解 Angular 提供的所有功能。无论如何，尽早开始创建项目，但是要确保你真的了解它们是如何工作的，并且当你找到更好的方法来达到你想要的结果时，准备好做出改变。

## 摘要

在这一章中，我为 Angular 提供了一些上下文。我解释了 Angular 如何支持 MVC 模式进行应用开发，并且简要概述了 REST 以及如何使用它来表达 HTTP 请求上的数据操作。我通过描述 Angular 项目中三个最常见的设计问题结束了这一章。在下一章中，我将提供一个快速入门的 HTML 和引导 CSS 框架，我将在本书的例子中使用。